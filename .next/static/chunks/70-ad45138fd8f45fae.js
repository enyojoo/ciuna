"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[70],{3070:function(e,r,t){t.d(r,{mc:function(){return y},Dp:function(){return g},te:function(){return _},oD:function(){return p},db:function(){return d},eH:function(){return u},OQ:function(){return c}});var n=t(3782),s=t(307);let o=s.env.NEXT_PUBLIC_SUPABASE_URL||s.env.SUPABASE_URL||"http://localhost:54321",i=s.env.NEXT_PUBLIC_SUPABASE_ANON_KEY||s.env.SUPABASE_ANON_KEY||"your-anon-key",a=s.env.SUPABASE_SERVICE_ROLE_KEY||"your-service-role-key",c=(0,n.eI)(o,i,{auth:{autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0}});(0,n.eI)(o,a,{auth:{autoRefreshToken:!1,persistSession:!1}});let l={async getCurrentUser(){let{data:{user:e},error:r}=await c.auth.getUser();if(r)throw r;return e},async getCurrentSession(){let{data:{session:e},error:r}=await c.auth.getSession();if(r)throw r;return e},async signUp(e,r,t){let{data:n,error:s}=await c.auth.signUp({email:e,password:r,options:{data:t}});if(s)throw s;return n},async signIn(e,r){let{data:t,error:n}=await c.auth.signInWithPassword({email:e,password:r});if(n)throw n;return t},async signInWithOAuth(e,r){let{data:t,error:n}=await c.auth.signInWithOAuth({provider:e,options:{redirectTo:(null==r?void 0:r.redirectTo)||"".concat(window.location.origin,"/auth/callback")}});if(n)throw n;return t},async signOut(){let{error:e}=await c.auth.signOut();if(e)throw e},async resetPassword(e,r){let{data:t,error:n}=await c.auth.resetPasswordForEmail(e,{redirectTo:(null==r?void 0:r.redirectTo)||"".concat(window.location.origin,"/auth/reset-password")});if(n)throw n;return t},async updatePassword(e){let{data:r,error:t}=await c.auth.updateUser({password:e});if(t)throw t;return r},async updateUser(e){let{data:r,error:t}=await c.auth.updateUser(e);if(t)throw t;return r},onAuthStateChange:e=>c.auth.onAuthStateChange(e)},u={async getCurrentProfile(){let e=await l.getCurrentUser();if(!e)return null;let{data:r,error:t}=await c.from("profiles").select("*").eq("id",e.id).single();if(t)throw t;return r},async getProfile(e){let{data:r,error:t}=await c.from("profiles").select("*").eq("id",e).single();if(t)throw t;return r},async createProfile(e){let{data:r,error:t}=await c.from("profiles").insert(e).select().single();if(t)throw t;return r},async updateProfile(e,r){let{data:t,error:n}=await c.from("profiles").update(r).eq("id",e).select().single();if(n)throw n;return t},async updateCurrentProfile(e){let r=await l.getCurrentUser();if(!r)throw Error("Not authenticated");return this.updateProfile(r.id,e)},async searchProfiles(e,r){let t=c.from("profiles").select("*").or("email.ilike.%".concat(e,"%,city.ilike.%").concat(e,"%,country_of_origin.ilike.%").concat(e,"%"));(null==r?void 0:r.role)&&(t=t.eq("role",r.role)),(null==r?void 0:r.city)&&(t=t.eq("city",r.city)),(null==r?void 0:r.verified_expat)!==void 0&&(t=t.eq("verified_expat",r.verified_expat));let{data:n,error:s}=await t;if(s)throw s;return n}},d={categories:{async getAll(){let{data:e,error:r}=await c.from("categories").select("*").eq("is_active",!0).order("sort_order",{ascending:!0});if(r)throw r;return e},async getById(e){let{data:r,error:t}=await c.from("categories").select("*").eq("id",e).single();if(t)throw t;return r},async create(e){let{data:r,error:t}=await c.from("categories").insert(e).select().single();if(t)throw t;return r},async update(e,r){let{data:t,error:n}=await c.from("categories").update(r).eq("id",e).select().single();if(n)throw n;return t}},listings:{async getAll(e){let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:20,n=c.from("listings").select("*",{count:"exact"});(null==e?void 0:e.category_id)&&(n=n.eq("category_id",e.category_id)),(null==e?void 0:e.city)&&(n=n.eq("city",e.city)),(null==e?void 0:e.district)&&(n=n.eq("district",e.district)),(null==e?void 0:e.min_price)&&(n=n.gte("price_rub",e.min_price)),(null==e?void 0:e.max_price)&&(n=n.lte("price_rub",e.max_price)),(null==e?void 0:e.condition)&&(n=n.eq("condition",e.condition)),(null==e?void 0:e.status)&&(n=n.eq("status",e.status)),(null==e?void 0:e.search)&&(n=n.or("title.ilike.%".concat(e.search,"%,description.ilike.%").concat(e.search,"%"))),(null==e?void 0:e.tags)&&e.tags.length>0&&(n=n.overlaps("tags",e.tags));let{data:s,error:o,count:i}=await n.order("created_at",{ascending:!1}).range((r-1)*t,r*t-1);if(o)throw o;return{data:s,total:i||0}},async getById(e){let{data:r,error:t}=await c.from("listings").select("*").eq("id",e).single();if(t)throw t;return r},async create(e){let{data:r,error:t}=await c.from("listings").insert(e).select().single();if(t)throw t;return r},async update(e,r){let{data:t,error:n}=await c.from("listings").update(r).eq("id",e).select().single();if(n)throw n;return t},async delete(e){let{error:r}=await c.from("listings").delete().eq("id",e);if(r)throw r}},vendors:{async getAll(e){let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:20,n=c.from("vendors").select("*",{count:"exact"}).eq("status","ACTIVE");(null==e?void 0:e.type)&&(n=n.eq("type",e.type)),(null==e?void 0:e.city)&&(n=n.eq("city",e.city)),(null==e?void 0:e.verified)!==void 0&&(n=n.eq("verified",e.verified));let{data:s,error:o,count:i}=await n.order("created_at",{ascending:!1}).range((r-1)*t,r*t-1);if(o)throw o;return{data:s,total:i||0}},async getById(e){let{data:r,error:t}=await c.from("vendors").select("*").eq("id",e).single();if(t)throw t;return r},async create(e){let{data:r,error:t}=await c.from("vendors").insert(e).select().single();if(t)throw t;return r},async update(e,r){let{data:t,error:n}=await c.from("vendors").update(r).eq("id",e).select().single();if(n)throw n;return t},async getByOwnerId(e){let{data:r,error:t}=await c.from("vendors").select("*").eq("owner_id",e).single();if(t)throw t;return r}},products:{async getAll(e){let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:20,n=c.from("vendor_products").select("*",{count:"exact"}).eq("status","ACTIVE");(null==e?void 0:e.vendor_id)&&(n=n.eq("vendor_id",e.vendor_id)),(null==e?void 0:e.category_id)&&(n=n.eq("category_id",e.category_id)),(null==e?void 0:e.min_price)&&(n=n.gte("price_rub",e.min_price)),(null==e?void 0:e.max_price)&&(n=n.lte("price_rub",e.max_price)),(null==e?void 0:e.is_local_stock)!==void 0&&(n=n.eq("is_local_stock",e.is_local_stock)),(null==e?void 0:e.is_dropship)!==void 0&&(n=n.eq("is_dropship",e.is_dropship)),(null==e?void 0:e.search)&&(n=n.or("name.ilike.%".concat(e.search,"%,description.ilike.%").concat(e.search,"%"))),(null==e?void 0:e.tags)&&e.tags.length>0&&(n=n.overlaps("tags",e.tags));let{data:s,error:o,count:i}=await n.order("created_at",{ascending:!1}).range((r-1)*t,r*t-1);if(o)throw o;return{data:s,total:i||0}},async getById(e){let{data:r,error:t}=await c.from("vendor_products").select("*").eq("id",e).single();if(t)throw t;return r},async create(e){let{data:r,error:t}=await c.from("vendor_products").insert(e).select().single();if(t)throw t;return r},async update(e,r){let{data:t,error:n}=await c.from("vendor_products").update(r).eq("id",e).select().single();if(n)throw n;return t}},services:{async getAll(e){let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:20,n=c.from("services").select("*",{count:"exact"}).eq("status","ACTIVE");(null==e?void 0:e.provider_id)&&(n=n.eq("provider_id",e.provider_id)),(null==e?void 0:e.category)&&(n=n.eq("category",e.category)),(null==e?void 0:e.min_price)&&(n=n.gte("price_rub",e.min_price)),(null==e?void 0:e.max_price)&&(n=n.lte("price_rub",e.max_price)),(null==e?void 0:e.is_online)!==void 0&&(n=n.eq("is_online",e.is_online)),(null==e?void 0:e.is_in_person)!==void 0&&(n=n.eq("is_in_person",e.is_in_person)),(null==e?void 0:e.location)&&(n=n.ilike("location","%".concat(e.location,"%"))),(null==e?void 0:e.search)&&(n=n.or("title.ilike.%".concat(e.search,"%,description.ilike.%").concat(e.search,"%"))),(null==e?void 0:e.tags)&&e.tags.length>0&&(n=n.overlaps("tags",e.tags));let{data:s,error:o,count:i}=await n.order("created_at",{ascending:!1}).range((r-1)*t,r*t-1);if(o)throw o;return{data:s,total:i||0}},async getById(e){let{data:r,error:t}=await c.from("services").select("*").eq("id",e).single();if(t)throw t;return r},async create(e){let{data:r,error:t}=await c.from("services").insert(e).select().single();if(t)throw t;return r},async update(e,r){let{data:t,error:n}=await c.from("services").update(r).eq("id",e).select().single();if(n)throw n;return t}},bookings:{async getAll(e){let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:20,n=c.from("service_bookings").select("*",{count:"exact"});(null==e?void 0:e.client_id)&&(n=n.eq("client_id",e.client_id)),(null==e?void 0:e.service_id)&&(n=n.eq("service_id",e.service_id)),(null==e?void 0:e.status)&&(n=n.eq("status",e.status));let{data:s,error:o,count:i}=await n.order("created_at",{ascending:!1}).range((r-1)*t,r*t-1);if(o)throw o;return{data:s,total:i||0}},async getById(e){let{data:r,error:t}=await c.from("service_bookings").select("*").eq("id",e).single();if(t)throw t;return r},async create(e){let{data:r,error:t}=await c.from("service_bookings").insert(e).select().single();if(t)throw t;return r},async update(e,r){let{data:t,error:n}=await c.from("service_bookings").update(r).eq("id",e).select().single();if(n)throw n;return t}},orders:{async getAll(e){let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:20,n=c.from("orders").select("*",{count:"exact"});(null==e?void 0:e.buyer_id)&&(n=n.eq("buyer_id",e.buyer_id)),(null==e?void 0:e.seller_id)&&(n=n.eq("seller_id",e.seller_id)),(null==e?void 0:e.status)&&(n=n.eq("status",e.status));let{data:s,error:o,count:i}=await n.order("created_at",{ascending:!1}).range((r-1)*t,r*t-1);if(o)throw o;return{data:s,total:i||0}},async getById(e){let{data:r,error:t}=await c.from("orders").select("*").eq("id",e).single();if(t)throw t;return r},async create(e){let{data:r,error:t}=await c.from("orders").insert(e).select().single();if(t)throw t;return r},async update(e,r){let{data:t,error:n}=await c.from("orders").update(r).eq("id",e).select().single();if(n)throw n;return t}},conversations:{async getAll(e){let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:20,{data:n,error:s,count:o}=await c.from("conversations").select("\n          *,\n          conversation_participants!inner(user_id)\n        ",{count:"exact"}).eq("conversation_participants.user_id",e).order("last_message_at",{ascending:!1,nullsFirst:!1}).range((r-1)*t,r*t-1);if(s)throw s;return{data:n,total:o||0}},async getById(e){let{data:r,error:t}=await c.from("conversations").select("*").eq("id",e).single();if(t)throw t;return r},async create(e){let{data:r,error:t}=await c.from("conversations").insert(e).select().single();if(t)throw t;return r}},messages:{async getAll(e){let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:50,{data:n,error:s,count:o}=await c.from("messages").select("*",{count:"exact"}).eq("conversation_id",e).order("created_at",{ascending:!1}).range((r-1)*t,r*t-1);if(s)throw s;return{data:n,total:o||0}},async create(e){let{data:r,error:t}=await c.from("messages").insert(e).select().single();if(t)throw t;return r},async markAsRead(e){let{error:r}=await c.from("messages").update({is_read:!0,read_at:new Date().toISOString()}).eq("id",e);if(r)throw r}},profiles:{async getAll(){let{data:e,error:r}=await c.from("profiles").select("*").order("created_at",{ascending:!1});if(r)throw r;return e||[]},async getById(e){let{data:r,error:t}=await c.from("profiles").select("*").eq("id",e).single();if(t)throw t;return r},async update(e,r){let{data:t,error:n}=await c.from("profiles").update(r).eq("id",e).select().single();if(n)throw n;return t}},serviceProviders:{async getAll(){let{data:e,error:r}=await c.from("service_providers").select("\n          *,\n          profile:profiles(*)\n        ").order("created_at",{ascending:!1});if(r)throw r;return e||[]},async getById(e){let{data:r,error:t}=await c.from("service_providers").select("\n          *,\n          profile:profiles(*)\n        ").eq("id",e).single();if(t)throw t;return r}}};class g{static async getLanguages(){if(this.languagesCache)return this.languagesCache;try{let{data:e,error:r}=await c.from("languages").select("*").eq("is_active",!0).order("name");if(r)return console.error("Error fetching languages:",r),[];return this.languagesCache=e||[],this.languagesCache}catch(e){return console.error("Error in getLanguages:",e),[]}}static async getTranslations(e){let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"common",t="".concat(e,":").concat(r);if(this.translationsCache.has(t))return this.translationsCache.get(t);try{let{data:n,error:s}=await c.from("translations").select("key, value").eq("language_code",e).eq("namespace",r);if(s)return console.error("Error fetching translations:",s),new Map;let o=new Map;return(n||[]).forEach(e=>{o.set(e.key,e.value)}),this.translationsCache.set(t,o),o}catch(e){return console.error("Error in getTranslations:",e),new Map}}static async getTranslation(e){let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"en",t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"common";try{let{data:n,error:s}=await c.rpc("get_translation",{p_key:e,p_language_code:r,p_namespace:t});if(s)return console.error("Error getting translation:",s),e;return n||e}catch(r){return console.error("Error in getTranslation:",r),e}}static async getLocalizedContent(e,r){let t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"en",n=arguments.length>3?arguments[3]:void 0;try{let{data:s,error:o}=await c.rpc("get_localized_content",{p_content_type:e,p_content_id:r,p_language_code:t,p_field_name:n});if(o)return console.error("Error getting localized content:",o),null;return s}catch(e){return console.error("Error in getLocalizedContent:",e),null}}static async setLocalizedContent(e,r,t,n,s){try{let{data:o,error:i}=await c.rpc("set_localized_content",{p_content_type:e,p_content_id:r,p_language_code:t,p_field_name:n,p_field_value:s});if(i)return console.error("Error setting localized content:",i),null;return o}catch(e){return console.error("Error in setLocalizedContent:",e),null}}static async getUserPreferences(e){try{let{data:r,error:t}=await c.from("profiles").select("preferred_language, timezone, date_format, time_format, currency_code").eq("id",e).single();if(t)return console.error("Error getting user preferences:",t),null;return{preferred_language:r.preferred_language||"en",timezone:r.timezone||"UTC",date_format:r.date_format||"MM/DD/YYYY",time_format:r.time_format||"12h",currency_code:r.currency_code||"RUB"}}catch(e){return console.error("Error in getUserPreferences:",e),null}}static async updateUserPreferences(e,r){try{let{error:t}=await c.from("profiles").update({preferred_language:r.preferred_language,timezone:r.timezone,date_format:r.date_format,time_format:r.time_format,currency_code:r.currency_code,updated_at:new Date().toISOString()}).eq("id",e);if(t)return console.error("Error updating user preferences:",t),!1;return!0}catch(e){return console.error("Error in updateUserPreferences:",e),!1}}static clearCache(){this.translationsCache.clear(),this.languagesCache=[]}static formatDate(e){let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"en",t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"UTC",n="string"==typeof e?new Date(e):e;try{return new Intl.DateTimeFormat(r,{timeZone:t,year:"numeric",month:"long",day:"numeric"}).format(n)}catch(e){return console.error("Error formatting date:",e),n.toLocaleDateString()}}static formatTime(e){let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"en",t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"UTC",n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"12h",s="string"==typeof e?new Date(e):e;try{return new Intl.DateTimeFormat(r,{timeZone:t,hour:"numeric",minute:"2-digit",hour12:"12h"===n}).format(s)}catch(e){return console.error("Error formatting time:",e),s.toLocaleTimeString()}}static formatCurrency(e){let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"RUB",t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"en";try{return new Intl.NumberFormat(t,{style:"currency",currency:r}).format(e)}catch(t){return console.error("Error formatting currency:",t),"".concat(e," ").concat(r)}}static formatNumber(e){let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"en",t=arguments.length>2?arguments[2]:void 0;try{return new Intl.NumberFormat(r,t).format(e)}catch(r){return console.error("Error formatting number:",r),e.toString()}}static formatRelativeTime(e){let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"en";arguments.length>2&&void 0!==arguments[2]&&arguments[2];let t="string"==typeof e?new Date(e):e,n=Math.floor((new Date().getTime()-t.getTime())/1e3);try{let e=new Intl.RelativeTimeFormat(r,{numeric:"auto"});if(n<60)return e.format(-n,"second");if(n<3600)return e.format(-Math.floor(n/60),"minute");if(n<86400)return e.format(-Math.floor(n/3600),"hour");if(n<2592e3)return e.format(-Math.floor(n/86400),"day");else if(n<31536e3)return e.format(-Math.floor(n/2592e3),"month");else return e.format(-Math.floor(n/31536e3),"year")}catch(e){return console.error("Error formatting relative time:",e),t.toLocaleDateString()}}}g.translationsCache=new Map,g.languagesCache=[];class _{static async getProviders(){try{let{data:e,error:r}=await c.from("payment_providers").select("*").eq("is_active",!0).order("display_name");if(r)return console.error("Error fetching payment providers:",r),[];return e||[]}catch(e){return console.error("Error in getProviders:",e),[]}}static async getPaymentMethods(e){try{let{data:r,error:t}=await c.from("payment_methods").select("\n          *,\n          payment_providers (\n            id,\n            name,\n            display_name,\n            provider_type\n          )\n        ").eq("user_id",e).order("is_default",{ascending:!1}).order("created_at",{ascending:!1});if(t)return console.error("Error fetching payment methods:",t),[];return r||[]}catch(e){return console.error("Error in getPaymentMethods:",e),[]}}static async addPaymentMethod(e,r,t,n,s){try{let{data:o,error:i}=await c.from("payment_methods").insert({user_id:e,provider_id:r,method_type:t,provider_method_id:n,metadata:s||{}}).select("id").single();if(i)return console.error("Error adding payment method:",i),{success:!1};return{success:!0,paymentMethodId:o.id}}catch(e){return console.error("Error in addPaymentMethod:",e),{success:!1}}}static async setDefaultPaymentMethod(e,r){try{await c.from("payment_methods").update({is_default:!1}).eq("user_id",e);let{error:t}=await c.from("payment_methods").update({is_default:!0}).eq("id",r).eq("user_id",e);if(t)return console.error("Error setting default payment method:",t),!1;return!0}catch(e){return console.error("Error in setDefaultPaymentMethod:",e),!1}}static async createPayment(e,r,t,n,s,o,i){try{let{data:a,error:l}=await c.rpc("create_payment_transaction",{p_user_id:e,p_order_id:r,p_provider_id:t,p_payment_method_id:n,p_amount:s,p_currency_code:o,p_metadata:i||{}});if(l)return console.error("Error creating payment transaction:",l),{success:!1};let u=await this.processPaymentWithProvider(t,a,s,o,n,i);return{success:u.success,transactionId:a,paymentUrl:u.paymentUrl}}catch(e){return console.error("Error in createPayment:",e),{success:!1}}}static async processPaymentWithProvider(e,r,t,n,s,o){try{let{data:i,error:a}=await c.from("payment_providers").select("*").eq("id",e).single();if(a||!i)return{success:!1};switch(i.provider_type){case"YOOMONEY":return await this.processYooMoneyPayment(i,r,t,n,s,o);case"STRIPE":return await this.processStripePayment(i,r,t,n,s,o);case"CASH":return await this.processCashPayment(i,r,t,n,o);case"BANK_TRANSFER":return await this.processBankTransferPayment(i,r,t,n,o);default:return{success:!1}}}catch(e){return console.error("Error processing payment with provider:",e),{success:!1}}}static async processYooMoneyPayment(e,r,t,n,s,o){try{let e="https://yoomoney.ru/checkout/payments/v2/show?orderId=".concat(r);return await c.from("payment_transactions").update({provider_transaction_id:"ym_".concat(r),provider_response:{payment_url:e,status:"pending"},status:"PROCESSING"}).eq("id",r),{success:!0,paymentUrl:e}}catch(e){return console.error("Error processing YooMoney payment:",e),{success:!1}}}static async processStripePayment(e,r,t,n,s,o){try{let e="https://checkout.stripe.com/pay/".concat(r);return await c.from("payment_transactions").update({provider_transaction_id:"pi_".concat(r),provider_response:{payment_url:e,status:"requires_payment_method"},status:"PROCESSING"}).eq("id",r),{success:!0,paymentUrl:e}}catch(e){return console.error("Error processing Stripe payment:",e),{success:!1}}}static async processCashPayment(e,r,t,n,s){try{return await c.from("payment_transactions").update({provider_transaction_id:"cash_".concat(r),provider_response:{status:"pending_verification",instructions:"Payment will be verified upon receipt of cash"},status:"PENDING"}).eq("id",r),{success:!0}}catch(e){return console.error("Error processing cash payment:",e),{success:!1}}}static async processBankTransferPayment(e,r,t,n,s){try{return await c.from("payment_transactions").update({provider_transaction_id:"bank_".concat(r),provider_response:{status:"pending_verification",instructions:"Transfer funds to the provided bank account",bank_details:{account_number:"1234567890",routing_number:"123456789",bank_name:"Example Bank"}},status:"PENDING"}).eq("id",r),{success:!0}}catch(e){return console.error("Error processing bank transfer payment:",e),{success:!1}}}static async getTransactionStatus(e){try{let{data:r,error:t}=await c.from("payment_transactions").select("*").eq("id",e).single();if(t)return console.error("Error fetching transaction status:",t),null;return r}catch(e){return console.error("Error in getTransactionStatus:",e),null}}static async getUserTransactions(e){let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:50,t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;try{let{data:n,error:s}=await c.from("payment_transactions").select("*").eq("user_id",e).order("created_at",{ascending:!1}).range(t,t+r-1);if(s)return console.error("Error fetching user transactions:",s),[];return n||[]}catch(e){return console.error("Error in getUserTransactions:",e),[]}}static async createEscrowAccount(e,r,t,n,s,o){try{let{data:i,error:a}=await c.from("escrow_accounts").insert({order_id:e,buyer_id:r,seller_id:t,amount:n,currency_code:s,release_conditions:o||{}}).select("id").single();if(a)return console.error("Error creating escrow account:",a),{success:!1};return{success:!0,escrowAccountId:i.id}}catch(e){return console.error("Error in createEscrowAccount:",e),{success:!1}}}static async releaseEscrowFunds(e,r){try{let{error:t}=await c.from("escrow_accounts").update({status:"RELEASED",released_at:new Date().toISOString(),released_by:r}).eq("id",e);if(t)return console.error("Error releasing escrow funds:",t),!1;return!0}catch(e){return console.error("Error in releaseEscrowFunds:",e),!1}}static async getExchangeRate(e,r,t){try{let{data:n,error:s}=await c.rpc("get_exchange_rate",{p_from_currency:e,p_to_currency:r,p_date:(null==t?void 0:t.toISOString())||new Date().toISOString()});if(s)return console.error("Error getting exchange rate:",s),null;return n}catch(e){return console.error("Error in getExchangeRate:",e),null}}static async convertCurrency(e,r,t){try{if(r===t)return{success:!0,convertedAmount:e,rate:1};let n=await this.getExchangeRate(r,t);if(!n)return{success:!1};return{success:!0,convertedAmount:Math.round(e*n),rate:n}}catch(e){return console.error("Error in convertCurrency:",e),{success:!1}}}static async processWebhook(e,r,t,n,s){try{let{data:o,error:i}=await c.rpc("process_payment_webhook",{p_provider_id:e,p_webhook_id:r,p_event_type:t,p_payload:n,p_signature:s||null});if(i)return console.error("Error processing webhook:",i),{success:!1};return{success:!0,webhookId:o}}catch(e){return console.error("Error in processWebhook:",e),{success:!1}}}}class p{static async search(e){let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"ALL",t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:20,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{},o=arguments.length>5?arguments[5]:void 0;try{let i=Date.now(),{data:a,error:l}=await c.rpc("search_content",{p_query:e,p_content_type:r,p_limit:t,p_offset:n,p_filters:s,p_user_id:o||null}),u=Date.now()-i;if(l)return console.error("Error searching content:",l),[];return o&&await c.from("search_queries").update({response_time_ms:u,results_count:(null==a?void 0:a.length)||0}).eq("user_id",o).order("created_at",{ascending:!1}).limit(1),a||[]}catch(e){return console.error("Error in search:",e),[]}}static async getSuggestions(e){let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:10;try{let{data:t,error:n}=await c.rpc("get_search_suggestions",{p_query:e,p_limit:r});if(n)return console.error("Error getting search suggestions:",n),[];return t||[]}catch(e){return console.error("Error in getSuggestions:",e),[]}}static async getFilters(){try{let{data:e,error:r}=await c.from("search_filters").select("*").eq("is_active",!0).order("sort_order");if(r)return console.error("Error fetching search filters:",r),[];return e||[]}catch(e){return console.error("Error in getFilters:",e),[]}}static async getUserPreferences(e){try{let{data:r,error:t}=await c.from("user_search_preferences").select("*").eq("user_id",e).single();if(t){if("PGRST116"===t.code)return{id:"",user_id:e,preferred_categories:[],preferred_locations:{},price_range_min:void 0,price_range_max:void 0,preferred_currency:"RUB",search_radius_km:50,notification_frequency:"DAILY",created_at:new Date().toISOString(),updated_at:new Date().toISOString()};return console.error("Error fetching user preferences:",t),null}return r}catch(e){return console.error("Error in getUserPreferences:",e),null}}static async updateUserPreferences(e,r){try{let{error:t}=await c.from("user_search_preferences").upsert({user_id:e,...r,updated_at:new Date().toISOString()});if(t)return console.error("Error updating user preferences:",t),!1;return!0}catch(e){return console.error("Error in updateUserPreferences:",e),!1}}static async getRecommendations(e,r){let t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:10;try{let n=c.from("search_recommendations").select("*").eq("is_active",!0).order("score",{ascending:!1}).limit(t);n=e?n.or("user_id.eq.".concat(e,",user_id.is.null")):n.is("user_id",null),r&&(n=n.eq("recommendation_type",r));let{data:s,error:o}=await n;if(o)return console.error("Error fetching recommendations:",o),[];return s||[]}catch(e){return console.error("Error in getRecommendations:",e),[]}}static async trackClick(e,r,t){try{let{error:n}=await c.from("search_queries").update({clicked_result_id:r,clicked_result_type:t}).eq("id",e);if(n)return console.error("Error tracking click:",n),!1;return!0}catch(e){return console.error("Error in trackClick:",e),!1}}static async getAnalytics(e,r,t){try{let n=c.from("search_analytics").select("*").gte("date",e).lte("date",r).order("date",{ascending:!1});t&&(n=n.eq("query_text",t));let{data:s,error:o}=await n;if(o)return console.error("Error fetching search analytics:",o),[];return s||[]}catch(e){return console.error("Error in getAnalytics:",e),[]}}static async getTrendingSearches(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:10;try{let{data:r,error:t}=await c.from("search_suggestions").select("*").eq("is_active",!0).eq("suggestion_type","TRENDING").order("popularity_score",{ascending:!1}).limit(e);if(t)return console.error("Error fetching trending searches:",t),[];return(null==r?void 0:r.map(e=>({suggestion:e.suggestion_text,type:e.suggestion_type,score:e.popularity_score})))||[]}catch(e){return console.error("Error in getTrendingSearches:",e),[]}}static async getPopularSearches(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:10;try{let{data:r,error:t}=await c.from("search_suggestions").select("*").eq("is_active",!0).eq("suggestion_type","POPULAR").order("click_count",{ascending:!1}).limit(e);if(t)return console.error("Error fetching popular searches:",t),[];return(null==r?void 0:r.map(e=>({suggestion:e.suggestion_text,type:e.suggestion_type,score:e.popularity_score})))||[]}catch(e){return console.error("Error in getPopularSearches:",e),[]}}static async addSuggestion(e,r,t,n){try{let{error:s}=await c.from("search_suggestions").insert({suggestion_text:e,suggestion_type:r,category_id:t,location_data:n||{},popularity_score:0,click_count:0});if(s)return console.error("Error adding search suggestion:",s),!1;return!0}catch(e){return console.error("Error in addSuggestion:",e),!1}}static async updateSuggestionPopularity(e){let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;try{let{error:t}=await c.from("search_suggestions").update({click_count:"click_count + ".concat(r),popularity_score:"popularity_score + ".concat(.1*r)}).eq("suggestion_text",e);if(t)return console.error("Error updating suggestion popularity:",t),!1;return!0}catch(e){return console.error("Error in updateSuggestionPopularity:",e),!1}}static async getSearchHistory(e){let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:20;try{let{data:t,error:n}=await c.from("search_queries").select("*").eq("user_id",e).order("created_at",{ascending:!1}).limit(r);if(n)return console.error("Error fetching search history:",n),[];return t||[]}catch(e){return console.error("Error in getSearchHistory:",e),[]}}static async clearSearchHistory(e){try{let{error:r}=await c.from("search_queries").delete().eq("user_id",e);if(r)return console.error("Error clearing search history:",r),!1;return!0}catch(e){return console.error("Error in clearSearchHistory:",e),!1}}static async getPerformanceMetrics(e,r){try{let{data:t,error:n}=await c.from("search_queries").select("*").gte("created_at",e).lte("created_at",r);if(n)return console.error("Error fetching performance metrics:",n),{totalSearches:0,avgResponseTime:0,clickThroughRate:0,topQueries:[]};let s=t||[],o=s.length,i=s.reduce((e,r)=>e+(r.response_time_ms||0),0)/o,a=s.filter(e=>e.clicked_result_id).length/o,l={};s.forEach(e=>{l[e.query_text]=(l[e.query_text]||0)+1});let u=Object.entries(l).sort((e,r)=>{let[,t]=e,[,n]=r;return n-t}).slice(0,10).map(e=>{let[r,t]=e;return{query:r,count:t}});return{totalSearches:o,avgResponseTime:Math.round(i),clickThroughRate:Math.round(100*a)/100,topQueries:u}}catch(e){return console.error("Error in getPerformanceMetrics:",e),{totalSearches:0,avgResponseTime:0,clickThroughRate:0,topQueries:[]}}}}class y{static async getSubscriptionPlans(){try{let{data:e,error:r}=await c.from("subscription_plans").select("*").eq("is_active",!0).order("price_monthly");if(r)return console.error("Error fetching subscription plans:",r),[];return e||[]}catch(e){return console.error("Error in getSubscriptionPlans:",e),[]}}static async getUserSubscription(e){try{let{data:r,error:t}=await c.from("user_subscriptions").select("\n          *,\n          subscription_plans (\n            id,\n            name,\n            plan_type,\n            features,\n            limits\n          )\n        ").eq("user_id",e).eq("status","ACTIVE").single();if(t){if("PGRST116"===t.code)return null;return console.error("Error fetching user subscription:",t),null}return r}catch(e){return console.error("Error in getUserSubscription:",e),null}}static async createSubscription(e,r,t,n){try{let{data:n,error:s}=await c.from("subscription_plans").select("*").eq("id",r).single();if(s||!n)return{success:!1};let o="YEARLY"===t?n.price_yearly:n.price_monthly,i=n.currency_code,a=new Date,l=new Date(a);l.setMonth(l.getMonth()+("YEARLY"===t?12:1));let{data:u,error:d}=await c.from("user_subscriptions").insert({user_id:e,plan_id:r,billing_cycle:t,price:o||n.price_monthly,currency_code:i,current_period_start:a.toISOString(),current_period_end:l.toISOString(),trial_ends_at:n.trial_days>0?new Date(a.getTime()+864e5*n.trial_days).toISOString():null,status:n.trial_days>0?"TRIAL":"ACTIVE"}).select("id").single();if(d)return console.error("Error creating subscription:",d),{success:!1};return{success:!0,subscriptionId:u.id}}catch(e){return console.error("Error in createSubscription:",e),{success:!1}}}static async cancelSubscription(e){let r=!(arguments.length>1)||void 0===arguments[1]||arguments[1];try{let{error:t}=await c.from("user_subscriptions").update({cancel_at_period_end:r,cancelled_at:r?null:new Date().toISOString(),status:r?"ACTIVE":"CANCELLED"}).eq("user_id",e).eq("status","ACTIVE");if(t)return console.error("Error canceling subscription:",t),!1;return!0}catch(e){return console.error("Error in cancelSubscription:",e),!1}}static async createBusinessReport(e,r,t,n,s,o){try{let{data:i,error:a}=await c.rpc("create_business_report",{p_user_id:e,p_report_type:r,p_title:t,p_date_range_start:n,p_date_range_end:s,p_filters:o||{}});if(a)return console.error("Error creating business report:",a),{success:!1};return{success:!0,reportId:i}}catch(e){return console.error("Error in createBusinessReport:",e),{success:!1}}}static async getBusinessReports(e){let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:20,t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;try{let{data:n,error:s}=await c.from("business_reports").select("*").eq("user_id",e).order("created_at",{ascending:!1}).range(t,t+r-1);if(s)return console.error("Error fetching business reports:",s),[];return n||[]}catch(e){return console.error("Error in getBusinessReports:",e),[]}}static async getBusinessMetrics(e,r,t){try{let{data:n,error:s}=await c.rpc("calculate_business_metrics",{p_user_id:e,p_start_date:r,p_end_date:t});if(s)return console.error("Error calculating business metrics:",s),{};return n||{}}catch(e){return console.error("Error in getBusinessMetrics:",e),{}}}static async getInventoryItems(e){let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:50,t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;try{let{data:n,error:s}=await c.from("inventory_items").select("*").eq("user_id",e).eq("is_active",!0).order("created_at",{ascending:!1}).range(t,t+r-1);if(s)return console.error("Error fetching inventory items:",s),[];return n||[]}catch(e){return console.error("Error in getInventoryItems:",e),[]}}static async createInventoryItem(e,r){try{let{data:t,error:n}=await c.from("inventory_items").insert({user_id:e,...r}).select("id").single();if(n)return console.error("Error creating inventory item:",n),{success:!1};return{success:!0,itemId:t.id}}catch(e){return console.error("Error in createInventoryItem:",e),{success:!1}}}static async updateInventoryQuantity(e,r,t,n,s,o,i){try{let{data:a,error:l}=await c.rpc("update_inventory_quantity",{p_inventory_item_id:e,p_quantity_change:r,p_movement_type:t,p_reason:n||null,p_reference_id:s||null,p_reference_type:o||null,p_created_by:i||null});if(l)return console.error("Error updating inventory quantity:",l),!1;return a}catch(e){return console.error("Error in updateInventoryQuantity:",e),!1}}static async getInventoryMovements(e){let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:50,t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;try{let{data:n,error:s}=await c.from("inventory_movements").select("*").eq("inventory_item_id",e).order("created_at",{ascending:!1}).range(t,t+r-1);if(s)return console.error("Error fetching inventory movements:",s),[];return n||[]}catch(e){return console.error("Error in getInventoryMovements:",e),[]}}static async getBusinessGoals(e,r){try{let t=c.from("business_goals").select("*").eq("user_id",e).order("created_at",{ascending:!1});r&&(t=t.eq("status",r));let{data:n,error:s}=await t;if(s)return console.error("Error fetching business goals:",s),[];return n||[]}catch(e){return console.error("Error in getBusinessGoals:",e),[]}}static async createBusinessGoal(e,r){try{let{data:t,error:n}=await c.from("business_goals").insert({user_id:e,...r}).select("id").single();if(n)return console.error("Error creating business goal:",n),{success:!1};return{success:!0,goalId:t.id}}catch(e){return console.error("Error in createBusinessGoal:",e),{success:!1}}}static async updateGoalProgress(e,r){try{let{data:t,error:n}=await c.from("business_goals").select("target_value").eq("id",e).single();if(n||!t)return!1;let s=Math.min(r/t.target_value*100,100),{error:o}=await c.from("business_goals").update({current_value:r,progress_percentage:s,status:s>=100?"COMPLETED":"ACTIVE"}).eq("id",e);if(o)return console.error("Error updating goal progress:",o),!1;return!0}catch(e){return console.error("Error in updateGoalProgress:",e),!1}}static async getBusinessNotifications(e){let r=arguments.length>1&&void 0!==arguments[1]&&arguments[1],t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:20,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;try{let s=c.from("business_notifications").select("*").eq("user_id",e).order("created_at",{ascending:!1}).range(n,n+t-1);r&&(s=s.eq("is_read",!1));let{data:o,error:i}=await s;if(i)return console.error("Error fetching business notifications:",i),[];return o||[]}catch(e){return console.error("Error in getBusinessNotifications:",e),[]}}static async markNotificationAsRead(e){try{let{error:r}=await c.from("business_notifications").update({is_read:!0}).eq("id",e);if(r)return console.error("Error marking notification as read:",r),!1;return!0}catch(e){return console.error("Error in markNotificationAsRead:",e),!1}}static async getLowInventoryAlerts(e){try{let{data:r,error:t}=await c.from("inventory_items").select("*").eq("user_id",e).eq("is_active",!0).lte("quantity","min_quantity");if(t)return console.error("Error fetching low inventory alerts:",t),[];return r||[]}catch(e){return console.error("Error in getLowInventoryAlerts:",e),[]}}static async getBusinessDashboard(e){try{let[r,t,n,s]=await Promise.all([this.getBusinessMetrics(e,new Date(Date.now()-2592e6).toISOString().split("T")[0],new Date().toISOString().split("T")[0]),this.getBusinessGoals(e,"ACTIVE"),this.getBusinessNotifications(e,!0,5),this.getLowInventoryAlerts(e)]);return{metrics:r,goals:t,notifications:n,lowInventory:s}}catch(e){return console.error("Error in getBusinessDashboard:",e),{metrics:{},goals:[],notifications:[],lowInventory:[]}}}}}}]);